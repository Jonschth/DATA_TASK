---
title: "Data_task"
author: "VJ"
date: "11 November 2022"
output: html_document
---

```{r setup, include=FALSE, fig.height=3,fig.height=3, fig.align='left'}
# Importing libraries
options(Encoding="UTF-8")
knitr::opts_chunk$set(message = FALSE)

library(readr)
library(lubridate)


library(data.table)
library(hablar)
library(tidyverse)
library(selectr)
library(readxl)
library(rjson)

library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(parameters)
library(gt)

library(htmltools)

library(magrittr)
library(knitr)
library(compareDF)
library(arsenal)


theme_set(theme_bw())
library("sf")


library("rnaturalearth")
library("rnaturalearthdata")
library(rgeos)

library(ggridges)

library(devtools)

library(kableExtra)

library(stargazer)

library (lubridate)

library (scales)

library(bbl)
library(fitdistrplus)

library(dplyr)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
# Loading data
Experiment_data <- read_csv("data/Experiment data.csv")
County_1_data <- read_csv("data/County 1 data.csv")
County_2_data <- read_csv("data/County 2 data.csv")
```

```{r}
# Converting County_2_data to same format as County_1_data using pivot_wider

County_2_data_reformatted <-
  County_2_data %>% 
    mutate(rn = rowid(student_id, variable)) %>%
    pivot_wider(names_from = variable, values_from = value, 
    values_fill = list(values = '0'))  %>% 
    mutate(female = case_when(male == 1 ~ 0,
                              male == 0 ~ 1))  %>% 
    dplyr:: select(c(1,4,3, 7,6)) 

    knitr::kable(head(County_2_data_reformatted,10), align = "ccccc",format = "pipe")
```

```{r}
# Combining County_1_data and County_2_data with Experiment_data using join

Experiment_data_merged <-
  Experiment_data %>% 
    left_join(County_1_data, by = c('student_id', 'county')) %>% 
    left_join(County_2_data_reformatted, by = c('student_id', 'county')) %>% 
    mutate (age = coalesce(age.x, age.y)) %>% 
    mutate(female = coalesce(female.x, female.y)) %>% 
    mutate(race = coalesce (race.x, race.y)) %>% 
    dplyr::select(c(1:2, 15:17,3:8))

    knitr::kable(head(Experiment_data_merged, 10),align = "cccccccccccc", format = "pipe")
```

### I have designed a proportions test to test if there is a significant difference in sending out different messages.


```{r}
# Data analysis, Research questions 1$2, informal message & social norms message
summary_table <-
  Experiment_data_merged %>% 
    #filter(female == 1) %>%
    # filter(race == 1) %>% 
    #filter(county == 2) %>% 
    #filter (age>=21) %>% 
    mutate(group = case_when(applied == 1 ~ "applied",
                               TRUE ~ "did not apply")) %>% 
    group_by(group,control_condition, info_condition, norms_condition) %>% 
    summarise(n())

knitr::kable(summary_table, align = "lcccc")

# proportional test prepared
control_applied <- as.numeric(summary_table[1,5])
control_not_apply <- as.numeric(summary_table[4,5])
n_control <- control_applied + control_not_apply

info_applied <- as.numeric(summary_table[2,5])
info_not_apply <- as.numeric(summary_table[5,5])
n_info <-info_applied + info_not_apply

norms_applied <- as.numeric(summary_table[3,5])
norms_not_apply <- as.numeric(summary_table[6,5])
n_norm <- norms_applied + norms_not_apply

# test for first research question
result <- prop.test(x = c(control_applied, info_applied), n = 
                   c(n_control, n_info), alternative = 'less',conf.level = 0.95)
result

# test for second research question
result <- prop.test(x = c(control_applied, norms_applied), n = 
                   c(n_control, n_norm), alternative = 'less',conf.level = 0.95)
result

# test for the third research question
result <- prop.test(x = c(info_applied, norms_applied), n = 
                   c(n_info, n_norm), alternative = 'less',conf.level = 0.95)
result


control_applied
info_applied
norms_applied

n_control
n_info
n_norm
```
### The results from the first test show that the null hypotheses is accepted as p-value > 0.05. The first test shows that it there is *not* a significant difference in proportion of applications from individuals in the control group and the group that got informational message at 95% significance level. Therefore the answer to research question 1 is no, more students do not apply if the get the informational message. 

### The results from the second test show that the null hypothesis is rejected as p-value < 0.05. There is significant difference in proportion of applications from individuals in the control group and the group that got social norms message emails at 95% significance level. Therefore the answer to research question 2 is yes, more students apply if the get the social norms message. In fact we could have tested this at 99% level, i.e. $\alpha$ = .01 and would have gotten the same message.

### The results from the third test show that the null hypothesis is rejected as the p-value < 0.05. There is significance difference in the proportions of applications from individuals that got the informational message and the social norms message at 95% significance level. Therefore the answer to research question 3 is yes, more students apply if they get the social norms message than students that get the informational message.

```{r}
# table with answers to research questions when different filters have been applied.
columns = c('filter','question 1', 'question 2', 'question 3')
R1 = c('female = 1', 'No', 'Yes', 'Yes')
R2 = c('  race = 1','No', 'Yes', 'No' )
R3 = c('county = 1','No', 'No', 'No' )
R4 = c('county = 2','No', 'Yes', 'Yes' )
R5 = c('  age < 21','No', 'Yes', 'No' )
R6 = c(' age >= 21','No', 'Yes', 'Yes' )

table <- as.data.frame(rbind(R1, R2, R3, R4, R5, R6), stringsAsFactors = FALSE)
names(table) <- columns
knitr::kable(table, align="rccc", caption = "Numbers for different races", row.names = FALSE, format = "pipe")
```

### The table shows that the answer to research question 1 is "No" irrespective of the filter applied. It also shows that the answers are the same for the total sample and females. Where is gets more interesting is when we start filtering for race and counties. 

### For county 1 it looks as if sending info message or norms message does not singificantly influence applicants. 

```{r}
#table where different groups of races are examined.
columns = c('groups','race = 1','race> 1')
R1 = c('control applied', 1573, 15)
R2 = c('total control', 10661, 10101)
R3 = c('info applied', 1632, 20)
R4 = c('total info', 10661, 10153)
R5 = c('norms applied',1727, 24 )
R6 = c('total norms', 10597, 10001 )

table <- as.data.frame(rbind(R1, R2, R3, R4, R5, R6), stringsAsFactors = FALSE)
names(table) <- columns
knitr::kable(table, align="lrr", caption = "Number of applicants and total numbers", row.names = FALSE, format = "pipe")
```

### In the table above results for different race groups is examined further. Interestingly, it seems as if only applicants of race = 1 did apply for the program. Other races (race >1) barely applied for the program at all. 